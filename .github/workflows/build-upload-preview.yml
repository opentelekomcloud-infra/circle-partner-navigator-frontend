name: Build and preview Circle Partner Navigator

on:
    pull_request:
        branches:
            - main

permissions:
    contents: read

jobs:
    cpn-build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '20'

            - name: Install dependencies
              run: yarn install

            - name: Build project
              env:
                  BASE_URL: ${{ secrets.BASE_URL }}
                  AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
              run: yarn build

            - name: Compress documentation into .tar.gz
              run: |
                  tar -czf cpn_build.tar.gz -C out/ .
                  mkdir -p ./library

            # - name: Write clouds.yaml
            #   run: |
            #       mkdir -p ~/.config/openstack
            #       cat > ~/.config/openstack/clouds.yaml <<EOF
            #       clouds:
            #         otc:
            #           profile: otc
            #           auth:
            #             auth_url: https://iam.eu-de.otc.t-systems.com:443/v3
            #             username: ${{ secrets.OTC_AUTH_USERNAME_PREVIEW }}
            #             password: ${{ secrets.OTC_AUTH_PASSWORD }}
            #             project_name: ${{ secrets.OTC_PROJECT_NAME_PREVIEW }}
            #             user_domain_name: ${{ secrets.OTC_DOMAIN }}
            #           interface: public
            #           identity_api_version: 3
            #           object_store_endpoint_override: ${{ secrets.OTC_ENDPOINT_STORAGE_PREVIEW }}
            #       EOF

            # - name: Install dependencies for Swift upload
            #   run: |
            #       python -m pip install openstacksdk ansible requests requestsexceptions ansible

            # - name: Upload to Swift as preview
            #   env:
            #     RUN_ID: ${{ github.run_id }}
            #   run: |
            #     ansible-playbook -i localhost, -M .github/workflows/library -e "run_id=$RUN_ID" playbooks/upload_swift_preview.yml

            # - name: Comment on PR with container name
            #   if: github.event_name == 'pull_request'
            #   env:
            #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            #     PREVIEW_URL: "${{ secrets.OTC_ENDPOINT_STORAGE_PREVIEW }}/gh_action_logs/opentelekomcloud-functiongraph-java/${{ github.run_id }}"
            #     PR_NUMBER: ${{ github.event.pull_request.number }}
            #   run: |
            #     COMMENT_BODY="ðŸ“¦ Preview-Documentation uploaded to Swift: ${PREVIEW_URL}/"
                
            #     curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            #         -H "Content-Type: application/json" \
            #         -X POST \
            #         -d "{\"body\": \"$COMMENT_BODY\"}" \
            #         "https://api.github.com/repos/${{ github.repository }}/issues/${PR_NUMBER}/comments"         

            - name: Upload artifacts to OBS
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.OTC_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.OTC_SECRET_ACCESS_KEY }}
                  AWS_DEFAULT_REGION: eu-de
              run: |
                  pip install "awscli<1.33.0"
                  export TARGET_PATH=s3://cpn-preview-site/
                  export ENDPOINT_URL=https://obs.eu-de.otc.t-systems.com
                  aws s3 rm "$TARGET_PATH" --recursive --endpoint-url "$ENDPOINT_URL"
                  aws s3 cp out/ "$TARGET_PATH" \
                    --endpoint-url "$ENDPOINT_URL" \
                    --recursive